function nthIndexOf(input, pattern, n) {
	const length = input.length;
	let i = -1;
	let j = n;
	while (j-- && i++ < length) {
		i = input.indexOf(pattern, i);
		if (i < 0) break;
	}
	return i;
}

const agdeZenbusVehicles = new Map([
	["zenbus:Vehicle:338850002:LOC", "109335"],
	["zenbus:Vehicle:316640004:LOC", "109334"],
	["zenbus:Vehicle:308550002:LOC", "109337"],
	["zenbus:Vehicle:318570002:LOC", "123036"],
	["zenbus:Vehicle:308550002:LOC", "153065"],
	["zenbus:Vehicle:302650002:LOC", "177017"],
	["zenbus:Vehicle:302660001:LOC", "189115"],
	["zenbus:Vehicle:338850001:LOC", "207014"],
	["zenbus:Vehicle:314610001:LOC", "207015"],
	["zenbus:Vehicle:322530001:LOC", "207017"],
	["zenbus:Vehicle:298720001:LOC", "207018"],
]);

/** @type {import('../src/model/source.ts').SourceOptions[]} */
const sources = [
	{
		id: "airbus-tlz",
		staticResourceHref: "https://pysae.com/api/v2/groups/airbus-toulouse/gtfs/pub",
		realtimeResourceHrefs: ["https://pysae.com/api/v2/groups/airbus-toulouse/gtfs-rt"],
		gtfsOptions: { shapesStrategy: "IGNORE" },
		mode: "NO-TU",
		excludeScheduled: true,
		getNetworkRef: () => "AIRBUS-TLZ",
		getVehicleRef: (vehicle) => vehicle?.label ?? undefined,
	},
	{
		id: "agde",
		staticResourceHref: "https://zenbus.net/gtfs/static/download.zip?dataset=agdecapbus68429531",
		realtimeResourceHrefs: ["https://zenbus.net/gtfs/rt/poll.proto?dataset=agdecapbus68429531"],
		gtfsOptions: { shapesStrategy: "IGNORE" },
		mode: "VP-ONLY",
		excludeScheduled: true,
		getNetworkRef: () => "CAPBUS",
		getVehicleRef: (vehicle) => (vehicle?.id ? agdeZenbusVehicles.get(vehicle.id) : undefined),
		mapLineRef: (lineRef) => lineRef.slice(nthIndexOf(lineRef, ":", 2) + 1, nthIndexOf(lineRef, ":", 3)),
		mapStopRef: (stopRef) => stopRef.slice(nthIndexOf(stopRef, ":", 3) + 1, nthIndexOf(stopRef, ":", 4)),
	},
	{
		id: "ales",
		staticResourceHref: "https://www.data.gouv.fr/fr/datasets/r/b9a0f32e-4386-454c-8759-b82653fa861e",
		realtimeResourceHrefs: [
			"https://alesy.plateforme-2cloud.com/api/gtfsrt/tripupdates/ALESY-6574-4401-7572/bin",
			"https://alesy.plateforme-2cloud.com/api/gtfsrt/vehiclepositions/ALESY-6574-4401-7572/bin",
		],
		gtfsOptions: { shapesStrategy: "IGNORE" },
		excludeScheduled: true,
		mode: "NO-TU",
		getNetworkRef: () => "ALESY",
		getVehicleRef: (vehicle) => vehicle?.label,
	},
	{
		id: "arles",
		staticResourceHref: "https://www.data.gouv.fr/fr/datasets/r/52216d2f-072e-4b7d-af0c-15d8d4e98b09",
		realtimeResourceHrefs: [
			"https://accm.2cloud.app/api/gtfsrt/2.0/tripupdates/LUMIPLAN-2021-4815-1108/bin",
			"https://accm.2cloud.app/api/gtfsrt/2.0/vehiclepositions/LUMIPLAN-2021-4815-1108/bin",
		],
		gtfsOptions: { shapesStrategy: "IGNORE" },
		mode: "NO-TU",
		excludeScheduled: true,
		getNetworkRef: () => "ENVIA",
	},
	{
		id: "auch",
		staticResourceHref: "https://zenbus.net/gtfs/static/download.zip?dataset=auch-alliance",
		realtimeResourceHrefs: ["https://zenbus.net/gtfs/rt/poll.proto?dataset=auch-alliance"],
		gtfsOptions: { shapesStrategy: "IGNORE" },
		mode: "NO-TU",
		excludeScheduled: true,
		getNetworkRef: () => "AUCH",
		getVehicleRef: () => undefined,
		mapLineRef: (lineRef) => lineRef.slice(nthIndexOf(lineRef, ":", 2) + 1, nthIndexOf(lineRef, ":", 3)),
		mapStopRef: (stopRef) => stopRef.slice(nthIndexOf(stopRef, ":", 3) + 1, nthIndexOf(stopRef, ":", 4)),
	},
	{
		id: "castres",
		staticResourceHref: "https://zenbus.net/gtfs/static/download.zip?dataset=castreslignesurbaines",
		realtimeResourceHrefs: ["https://zenbus.net/gtfs/rt/poll.proto?dataset=castreslignesurbaines"],
		gtfsOptions: { shapesStrategy: "IGNORE" },
		mode: "NO-TU",
		excludeScheduled: true,
		getNetworkRef: () => "LIBELLUS",
		getVehicleRef: () => undefined,
	},
	{
		id: "lio-global",
		staticResourceHref:
			"https://app.mecatran.com/utw/ws/gtfsfeed/static/lio?apiKey=2b160d626f783808095373766f18714901325e45&type=gtfs_lio",
		realtimeResourceHrefs: [],
		// -- REQUEST TO GET REALTIME LINES
		// with realtime_lines as (
		// 	select distinct l."number" as line_number
		// 	from line l
		// 	join line_activity la on la.line_id = l.id
		// 	where la.vehicle_id in (select v.id from vehicle v where v.network_id = 83)
		// 	order by l."number" asc
		// )
		// select json_agg(line_number) from realtime_lines;
		excludeScheduled: (trip) =>
			[
				"101",
				"102",
				"103",
				"104",
				"105",
				"106",
				"108",
				"109",
				"110",
				"112",
				"113",
				"114",
				"115",
				"121",
				"122",
				"123",
				"125",
				"130",
				"132",
				"133",
				"134",
				"135",
				"136",
				"140",
				"141",
				"142",
				"150",
				"151",
				"152",
				"401",
				"402",
				"404",
				"408",
				"500",
				"503",
				"510",
				"520",
				"521",
				"530",
				"540",
				"541",
				"542",
				"543",
				"550",
				"560",
				"570",
				"571",
				"572",
				"573",
				"574",
				"8001",
				"8003",
				"8011",
				"8012",
				"8013",
				"8015",
				"8016",
				"8031",
				"8033",
				"8035",
				"8050",
				"8061",
				"8062",
				"8063",
				"8081",
				"8083",
				"8084",
				"8091",
				"8092",
				"8101",
				"8102",
				"8103",
				"8106",
				"8111",
				"8112",
				"8113",
				"8121",
				"8124",
				"8125",
				"8126",
				"8131",
				"8132",
				"8134",
				"8141",
				"8142",
				"8143",
				"8151",
				"8152",
				"8153",
				"8154",
				"8155",
				"8157",
				"8158",
				"8159",
				"8160",
				"8162",
				"8181",
				"8191",
				"8192",
				"8201",
				"8202",
				"8203",
				"8211",
				"8212",
				"8213",
				"8222",
				"8231",
				"8244",
				"8250",
				"8261",
				"8270",
				"8271",
				"8272",
				"8273",
				"8281",
				"8282",
				"8283",
				"8284",
				"8290",
				"8300",
				"8310",
				"8311",
				"8312",
				"8314",
				"8321",
				"8331",
				"8332",
				"8333",
				"8340",
				"8341",
				"8342",
				"8343",
				"8344",
				"8350",
				"8361",
				"8362",
				"8371",
				"8372",
				"8373",
				"8391",
				"8392",
				"8400",
				"8410",
				"8432",
				"8501",
				"8502",
				"8503",
				"8504",
				"8505",
				"8506",
				"8507",
				"8508",
				"8509",
				"8601",
				"8602",
				"8603",
				"8604",
				"8605",
				"8606",
				"8607",
				"8608",
				"8609",
				"8610",
				"8611",
				"8612",
				"8613",
				"8614",
				"8615",
				"8616",
				"8617",
				"8618",
				"8620",
				"8621",
				"8623",
				"8624",
				"8625",
				"8626",
				"8627",
				"8628",
				"8630",
				"8631",
				"8632",
				"8633",
				"8634",
				"8635",
				"8636",
				"8637",
				"8638",
				"8639",
				"8640",
				"8641",
				"8642",
				"8643",
				"8700",
				"8701",
				"8702",
				"8703",
				"8704",
				"8705",
				"8706",
				"8707",
				"8708",
				"8709",
				"8710",
				"8711",
				"8712",
				"8713",
				"878",
				"8810",
				"8811",
				"8820",
				"8830",
				"8840",
				"889",
				"890",
				"891",
				"8931",
				"8932",
				"8933",
				"8934",
				"8941",
				"8942",
				"8943",
				"COOP",
				"Navette Grau-du-Roi",
			].includes(trip.route.id),
		getNetworkRef: (journey) => {
			if (journey.trip.route.agency.name === "Herault Transport") return "HERAULT-TRANSPORT";
			if (journey.trip.route.agency.name === "liO Occitanie 09") return "LIO-09";
			if (journey.trip.route.agency.name === "liO Occitanie 11") return "LIO-11";
			if (journey.trip.route.agency.name === "liO Occitanie 12") return "LIO-12";
			if (journey.trip.route.agency.name === "liO Occitanie 30") return "LIO-30";
			if (journey.trip.route.agency.name === "liO Occitanie 31") return "LIO-31";
			if (journey.trip.route.agency.name === "liO Occitanie 32") return "LIO-32";
			if (journey.trip.route.agency.name === "liO Occitanie 46") return "LIO-46";
			if (journey.trip.route.agency.name === "liO Occitanie 48") return "LIO-48";
			if (journey.trip.route.agency.name === "liO Occitanie 65") return "LIO-65";
			if (journey.trip.route.agency.name === "liO Occitanie 66") return "LIO-66";
			if (journey.trip.route.agency.name === "liO Occitanie 81") return "LIO-81";
			if (journey.trip.route.agency.name === "liO Occitanie 82") return "LIO-82";
			return null; // will be ignored
		},
	},
	{
		id: "lio-gard",
		staticResourceHref: "https://pysae.com/api/v2/groups/lio-gard/gtfs/pub",
		realtimeResourceHrefs: ["https://pysae.com/api/v2/groups/lio-gard/gtfs-rt"],
		gtfsOptions: { shapesStrategy: "IGNORE" },
		excludeScheduled: true,
		mode: "NO-TU",
		mapLineRef: (lineRef) => lineRef.split("|")[0],
		getNetworkRef: () => "LIO-30",
		getVehicleRef: (vehicle) => {
			if (typeof vehicle?.label !== "string") return;
			if (vehicle.label.startsWith("LOT")) return;
			return vehicle.label;
		},
	},
	{
		id: "lio-gard-keolis",
		staticResourceHref: "https://pysae.com/api/v2/groups/lio-gard-keolis/gtfs/pub",
		realtimeResourceHrefs: ["https://pysae.com/api/v2/groups/lio-gard-keolis/gtfs-rt"],
		gtfsOptions: { shapesStrategy: "IGNORE" },
		excludeScheduled: true,
		mode: "NO-TU",
		getNetworkRef: () => "LIO-30",
		getVehicleRef: (vehicle) => {
			if (typeof vehicle?.label !== "string") return;
			if (vehicle.label.startsWith("LOT")) return;
			return vehicle.label;
		},
	},
	{
		id: "lio-lot",
		staticResourceHref: "https://pysae.com/api/v2/groups/lio-lot/gtfs/pub",
		realtimeResourceHrefs: ["https://pysae.com/api/v2/groups/lio-lot/gtfs-rt"],
		gtfsOptions: { shapesStrategy: "IGNORE" },
		excludeScheduled: true,
		mode: "NO-TU",
		mapLineRef: (lineRef) => lineRef.split("|")[0],
		getNetworkRef: () => "LIO-46",
		getVehicleRef: (vehicle) => {
			if (typeof vehicle?.label !== "string") return;
			if (vehicle.label.startsWith("LOT")) return;
			return vehicle.label;
		},
	},
	{
		id: "montpellier",
		staticResourceHref: "https://data.montpellier3m.fr/GTFS/Urbain/GTFS.zip",
		realtimeResourceHrefs: [
			"https://data.montpellier3m.fr/GTFS/Urbain/VehiclePosition.pb",
			"https://data.montpellier3m.fr/GTFS/Urbain/TripUpdate.pb",
		],
		mode: "NO-TU",
		getNetworkRef: () => "TAM",
	},
	{
		id: "montpellier-sub",
		staticResourceHref: "https://data.montpellier3m.fr/GTFS/Suburbain/GTFS.zip",
		realtimeResourceHrefs: [
			"https://data.montpellier3m.fr/GTFS/Suburbain/VehiclePosition.pb",
			"https://data.montpellier3m.fr/GTFS/Suburbain/TripUpdate.pb",
		],
		mode: "NO-TU",
		getNetworkRef: () => "TAM",
	},
	{
		id: "pays-or",
		staticResourceHref: "https://www.data.gouv.fr/fr/datasets/r/bbbd5a29-2fbf-47ae-84fd-6d1ebb758eeb",
		realtimeResourceHrefs: [
			"https://proxy.transport.data.gouv.fr/resource/transpor-gtfs-rt-trip-update",
			"https://proxy.transport.data.gouv.fr/resource/transpor-gtfs-rt-vehicle-position",
		],
		gtfsOptions: { shapesStrategy: "IGNORE" },
		excludeScheduled: true,
		mode: "NO-TU",
		getNetworkRef: () => "TRANSPOR",
		getDestination: (journey) => journey?.calls.at(-1)?.stop.name,
		getVehicleRef: (vehicleDescriptor) => vehicleDescriptor?.label?.replaceAll(" ", ""),
	},
	{
		id: "perpignan",
		staticResourceHref:
			"https://eur.mecatran.com/utw/ws/gtfsfeed/static/perpignan?apiKey=612f606b5e3b0a3e6e1f441a2c4a050f6a345b55",
		realtimeResourceHrefs: [
			"https://eur.mecatran.com/utw/ws/gtfsfeed/vehicles/perpignan?apiKey=612f606b5e3b0a3e6e1f441a2c4a050f6a345b55",
			"https://eur.mecatran.com/utw/ws/gtfsfeed/realtime/perpignan?apiKey=612f606b5e3b0a3e6e1f441a2c4a050f6a345b55",
		],
		gtfsOptions: { shapesStrategy: "IGNORE" },
		excludeScheduled: true,
		mode: "NO-TU",
		getNetworkRef: () => "SANKEO",
		getVehicleRef: (vehicle) => vehicle?.label ?? undefined,
	},
	{
		id: "sete",
		staticResourceHref: "https://sete.ceccli.com/gtfs/gtfs.zip",
		realtimeResourceHrefs: [
			"https://sete.ceccli.com/gtfs/TripUpdates.pb",
			"https://sete.ceccli.com/gtfs/VehiclePositions.pb",
		],
		gtfsOptions: { shapesStrategy: "IGNORE" },
		excludeScheduled: true,
		mode: "NO-TU",
		getNetworkRef: () => "SAM",
		mapVehiclePosition: (vehicle) => (vehicle.trip ? vehicle : undefined),
	},
	{
		id: "toulouse",
		staticResourceHref:
			"https://data.toulouse-metropole.fr/explore/dataset/tisseo-gtfs/files/fc1dda89077cf37e4f7521760e0ef4e9/download/",
		realtimeResourceHrefs: [],
		gtfsOptions: {
			filterTrips: (trip) => {
				trip.route.id = trip.route.name;
				return true;
			},
		},
		excludeScheduled: (trip) =>
			[
				"25",
				"26",
				"31",
				"31p",
				"32",
				"33",
				"40",
				"41",
				"42",
				"43",
				"46",
				"49",
				"50",
				"51",
				"53",
				"55",
				"69",
				"71",
				"74",
				"75",
				"80",
				"82",
				"101",
				"102",
				"103",
				"104",
				"107",
				"109",
				"110",
				"111",
				"112",
				"113",
				"114",
				"115",
				"116",
				"117",
				"121",
				"126",
				"131",
				"132",
				"151",
				"152",
				"169",
				"201",
				"202",
				"204",
				"205",
				"301",
				"302",
				"303",
				"304",
				"305",
				"306",
				"310",
				"311",
				"312",
				"313",
				"314",
				"315",
				"316",
				"317",
				"318",
				"320",
				"321",
				"401",
				"402",
				"NVACC",
			].includes(trip.route.name),
		mapStopRef: (stopRef) => stopRef.slice(stopRef.indexOf(":") + 1),
		getNetworkRef: () => "TISSEO",
	},
];

/** @type {import('../src/configuration/configuration.ts').Configuration} */
const configuration = {
	computeDelayMs: 30_000,
	redisOptions: {
		url: process.env.REDIS_URL ?? "redis://127.0.0.1:6379",
		username: process.env.REDIS_USERNAME,
		password: process.env.REDIS_PASSWORD,
	},
	sources,
};

export default configuration;
